---
title: Прямая миграция в Office 365 с помощью PowerShell
ms.author: sirkkuw
author: sirkkuw
manager: laurawi
audience: Admin
ms.topic: article
ms.service: o365-administration
localization_priority: Normal
ms.collection: Ent_O365
f1.keywords:
- NOCSH
ms.custom: ''
ms.assetid: b468cb4b-a35c-43d3-85bf-65446998af40
description: Сводка. Узнайте, как использовать Windows PowerShell для прямой миграции в Office 365.
ms.openlocfilehash: 6f82dc8501d5dfbca7c980b025e6da7a4deb00d5
ms.sourcegitcommit: 99411927abdb40c2e82d2279489ba60545989bb1
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/07/2020
ms.locfileid: "41844720"
---
# <a name="use-powershell-to-perform-a-cutover-migration-to-office-365"></a>Прямая миграция в Office 365 с помощью PowerShell

 **Сводка.** Узнайте, как выполнить прямую миграцию в Office 365, используя Windows PowerShell.
  
Вы можете одновременно перенести содержимое почтовых ящиков пользователей из исходной системы электронной почты в Office 365:, используя прямую миграцию. В этой статье описаны задачи, которые выполняются при прямой миграции электронной почты с помощью Exchange Online PowerShell. 
  
Процесс миграции в общих чертах рассматривается в статье [Что необходимо знать о прямой миграции электронной почты в Office 365](https://go.microsoft.com/fwlink/p/?LinkId=536688). Ознакомившись с содержимым этой статьи, начните переносить почтовые ящики из одной почтовой системы в другую, руководствуясь приведенными в этой статье сведениями.
  
> [!NOTE]
> Для прямой миграции можно также использовать Центр администрирования Exchange. См. статью [Прямая миграция электронной почты в Office 365](https://go.microsoft.com/fwlink/p/?LinkId=536689). 
  
## <a name="what-do-you-need-to-know-before-you-begin"></a>Что нужно знать перед началом работы?

Предполагаемое время выполнения задачи: от 2 до 5 минут для создания пакета миграции. После запуска пакета миграции продолжительность миграции будет зависеть от количества почтовых ящиков в пакете, размера каждого почтового ящика и доступной пропускной способности сети. Подробнее о других факторах, влияющих на продолжительность миграции почтовых ящиков в Office 365:, см. в статье [Производительность миграции](https://go.microsoft.com/fwlink/p/?LinkId=275079)
  
Для выполнения этой процедуры (процедур) необходимы соответствующие разрешения. Сведения о необходимых разрешениях см. в пункте "Миграция" статьи [Разрешения получателей](https://go.microsoft.com/fwlink/p/?LinkId=534105) в соответствующей таблице.
  
Чтобы использовать командлеты Exchange Online PowerShell, вам необходимо войти в систему и импортировать командлеты в локальный сеанс Windows PowerShell. Инструкции см в статье [Подключение к Exchange Online с помощью удаленной оболочки PowerShell](https://go.microsoft.com/fwlink/p/?LinkId=534121).
  
Полный список команд миграции см. в статье [Командлеты перемещения и миграции](https://go.microsoft.com/fwlink/p/?LinkId=534750).
  
## <a name="migration-steps"></a>Шаги миграции

### <a name="step-1-prepare-for-a-cutover-migration"></a>Шаг 1. Подготовка к прямой миграции
<a name="BK_Step1"> </a>

- **Добавьте локальную организацию Exchange в качестве обслуживаемого домена организации Office 365.** Служба миграции использует SMTP-адрес локальных почтовых ящиков для создания идентификатора пользователя Microsoft Online Services и адреса электронной почты для новых почтовых ящиков Office 365:. Выполнить миграцию не удастся, если домен Exchange не является обслуживаемым или основным доменом организации Office 365:. Дополнительные сведения см. в статье[Проверка домена в Office 365](https://go.microsoft.com/fwlink/p/?LinkId=534110).
    
- **Настройте мобильный Outlook на локальном сервере Exchange.** Служба миграции электронной почты использует протокол RPC через HTTP, также называемый мобильный Outlook, для подключения к локальному серверу Exchange Server. Дополнительные сведения о настройке службы мобильный Outlook для Exchange 2010, Exchange 2007 и Exchange 2003 см. в следующих статьях.
    
  - [Exchange 2010. Включение мобильного Outlook](https://go.microsoft.com/fwlink/?LinkID=187249)
    
  - [Exchange 2007. Инструкции по включению мобильного Outlook](https://go.microsoft.com/fwlink/?LinkID=167210)
    
  - [Exchange 2003. Сценарии развертывания для RPC через HTTP](https://go.microsoft.com/fwlink/?LinkID=73657)
    
  - [Настройка мобильного Outlook в Exchange 2003](https://go.microsoft.com/fwlink/?LinkID=167209)
    
    > [!IMPORTANT]
    > Конфигурацию мобильного Outlook необходимо настроить с использованием сертификата, выпущенного доверенным центром сертификации (ЦС). Настройка с использованием самозаверяющего сертификата невозможна. Дополнительные сведения см. в статье [Инструкции по настройке протокола SSL для мобильного Outlook](https://go.microsoft.com/fwlink/?LinkID=80875). 
  
- **Проверьте возможность подключения к организации Exchange с помощью мобильного Outlook.** Проверьте настройки подключения с использованием следующих способов.
    
  - Подключитесь к локальному почтовому ящику Exchange с помощью Microsoft Outlook из-за пределов корпоративной сети.
    
  - Проверьте настройки подключения с помощью [анализатора удаленного подключения Exchange](https://www.testexchangeconnectivity.com/) корпорации Майкрософт. Используйте средства мобильного Outlook (RPC через HTTP) или проверки автообнаружения Outlook.
    
  - В Exchange Online PowerShell выполните следующие команды.
    
  ```
  $Credentials = Get-Credential
  ```

  ```
  Test-MigrationServerAvailability -ExchangeOutlookAnywhere -Autodiscover -EmailAddress <email address for on-premises administrator> -Credentials $credentials
  ```

- **Назначьте для локальной учетной записи необходимые разрешения на доступ к почтовым ящикам в организации Exchange.** Локальная учетная запись пользователя, которая используется для подключения к локальной организации Exchange (также называемую администратором миграции), должна иметь необходимые разрешения для доступа к локальным почтовым ящикам, которые необходимо перенести в Office 365. Эта учетная запись пользователя необходима для создания конечной точки миграции в вашей локальной организации.
    
    В следующем списке перечислены права администратора, необходимые для переноса почтовых ящиков с помощью прямой миграции. У вас есть три варианта.
    
  - Администратор миграции должен быть членом группы **Администраторы домена** в службе каталогов Active Directory локальной организации.
    
    ИЛИ
    
  - Администратор миграции должен иметь разрешение **FullAccess** для всех локальных почтовых ящиков.
    
    Или
    
  - Администратор миграции должен иметь разрешение **Получить как** в локальной базе данных, где хранятся почтовые ящики пользователей.
    
- **Отключите единую систему обмена сообщениями.** Если для локальных почтовых ящиков включена поддержка единой системы обмена сообщениями, ее необходимо отключить, прежде чем переносить почтовые ящики. После завершения миграции поддержку единой системы обмена сообщениями для этих ящиков можно снова включить.
    
- **Группы безопасности и делегаты.** Служба миграции электронной почты не может определить, являются ли локальные группы Active Directory группами безопасности, поэтому эта служба не может подготовить к работе перенесенные группы в качестве групп безопасности в Office 365. Если вы хотите иметь группы безопасности в клиенте Office 365, сначала необходимо подготовить к работе пустую группу безопасности, поддерживающую почту, в клиенте Office 365 перед запуском прямой миграции. Кроме того, этот метод миграции обеспечивает перемещение только почтовых ящиков, почтовых пользователей, почтовых контактов и групп, поддерживающих почту. Если любой другой объект Active Directory, например пользователь, не перенесенный в Office 365:, назначается в качестве руководителя или делегата для переносимого объекта, перед миграцией их необходимо удалить из объекта.
    
### <a name="step-2-create-a-migration-endpoint"></a>Шаг 2. Создание конечной точки миграции
<a name="BK_Step2"> </a>

Для успешного переноса электронной почты решение Office 365: должно обмениваться данными с исходной системой электронной почты. Для этого Office 365 использует конечную точку миграции. Чтобы создать конечную точку миграции мобильного Outlook для прямой миграции, сначала [подключитесь к Exchange Online](https://go.microsoft.com/fwlink/p/?LinkId=534121). 
  
Полный список команд миграции см. в статье [Командлеты перемещения и миграции](https://go.microsoft.com/fwlink/p/?LinkId=534750).
  
В Exchange Online PowerShell выполните следующие команды.
  
```
$Credentials = Get-Credential
```

В примере используется командлет [Test-MigrationServerAvailability](https://go.microsoft.com/fwlink/p/?LinkId=534752), который получает и проверяет параметры подключения к локальному серверу Exchange, а затем использует эти параметры для создания конечной точки миграции CutoverEndpoint.
  
```
$TSMA = Test-MigrationServerAvailability -ExchangeOutlookAnywhere -Autodiscover -EmailAddress administrator@contoso.com -Credentials $credentials
```

```
New-MigrationEndpoint -ExchangeOutlookAnywhere -Name CutoverEndpoint -ConnectionSettings $TSMA.ConnectionSettings
```

> [!NOTE]
> С помощью командлета **New-MigrationEndpoint** и параметра **-TargetDatabase** можно указать базу данных, которая будет использоваться службой. В противном случае база данных назначается случайным образом на сайте Службы федерации Active Directory (AD FS) 2.0, на котором расположен почтовый ящик управления.
  
#### <a name="verify-it-worked"></a>Проверка работы

В Exchange Online PowerShell выполните следующую команду, чтобы отобразить сведения о конечной точке миграции CutoverEndpoint.
  
```
Get-MigrationEndpoint CutoverEndpoint | Format-List EndpointType,ExchangeServer,UseAutoDiscover,Max*

```

### <a name="step-3-create-the-cutover-migration-batch"></a>Шаг 3. Создание пакета прямой миграции
<a name="BK_Step3"> </a>

Чтобы создать пакет для прямой миграции, выполните командлет **New-MigrationBatch** в Exchange Online PowerShell. Можно создать пакет миграции и запустить его обработку автоматически, включив параметр _AutoStart_. Кроме того, вы можете создать пакет миграции, а затем вручную запустить его с помощью командлета **Start-MigrationBatch**. В этом примере создается пакет миграции CutoverBatch и используется конечная точка миграции, созданная на предыдущем шаге.
  
```
New-MigrationBatch -Name CutoverBatch -SourceEndpoint CutoverEndpoint -AutoStart
```

В этом примере также создается пакет миграции CutoverBatch и используется конечная точка миграции, созданная на предыдущем шаге. Так как параметр  _AutoStart_ не включен, пакет миграции необходимо запустить вручную на панели мониторинга миграции или с помощью командлета **Start-MigrationBatch**. Как было сказано выше, в одно и то же время может существовать только один пакет прямой миграции.
  
```
New-MigrationBatch -Name CutoverBatch -SourceEndpoint CutoverEndpoint
```

#### <a name="verify-it-worked"></a>Проверка работы

Чтобы убедиться, что вы успешно создали пакет прямой миграции, выполните следующую команду в Exchange Online PowerShell для отображения сведений о новом пакете миграции.
  
```
Get-MigrationBatch | Format-List
```

### <a name="step-4-start-the-cutover-migration-batch"></a>Шаг 4. Запуск пакета прямой миграции
<a name="BK_Step4"> </a>

Чтобы запустить пакет миграции в Exchange Online PowerShell, выполните следующую команду. Будет создан пакет миграции CutoverBatch.
  
```
Start-MigrationBatch -Identity CutoverBatch
```

#### <a name="verify-it-worked"></a>Проверка работы

Если пакет миграции успешно запущен, состояние пакета на панели мониторинга миграции изменится на "Синхронизация". Чтобы убедиться, вы успешно запустили пакет миграции с помощью Exchange Online PowerShell, выполните следующую команду.
  
```
Get-MigrationBatch -Identity CutoverBatch |  Format-List Status
```

### <a name="step-5-route-your-email-to-office-365"></a>Шаг 5. Маршрутизация электронной почты в Office 365
<a name="BK_Step5"> </a>

Чтобы выяснить, куда доставлять сообщения электронной почты, системы электронной почты используют DNS-запись, которая называется записью MX. В процессе миграции электронной почты запись MX указывала на вашу исходную систему электронной почты. Теперь, когда перенос электронной почты в Office 365: завершен, запись MX должна указывать на Office 365:. Это обеспечит доставку электронной почты в ваши почтовые ящики Office 365:. Перемещая запись MX, вы также сможете отключить старую систему электронной почты, когда будете готовы сделать это. 
  
Многим поставщикам DNS следует придерживаться инструкций по [изменению записи MX](https://go.microsoft.com/fwlink/p/?LinkId=279163). Если ваш поставщик DNS не включен в этот список, или если вы хотите получить представление об общих указаниях, см. [статью с общими инструкции в отношении записи MX](https://go.microsoft.com/fwlink/?LinkId=397449).
  
Системам электронной почты клиентов и партнеров может потребоваться до 72 часов, чтобы распознать измененную запись MX. Подождите по крайней мере 72 часа, прежде чем перейти к следующей задаче: [Шаг 6. Удаление пакета прямой миграции](use-powershell-to-perform-a-cutover-migration-to-office-365.md#Bk_step6). 
  
### <a name="step-6-delete-the-cutover-migration-batch"></a>Шаг 6. Удаление пакета прямой миграции
<a name="Bk_step6"> </a>

После того как вы измените запись MX и убедитесь, что вся электронная почта направляется в почтовые ящики Office 365:, уведомите пользователей о том, что их сообщения доставляются в Office 365. Затем можно удалить пакет прямой миграции. Убедитесь в следующем, прежде чем удалить пакет миграции.
  
- Все пользователи используют почтовые ящики Office 365:. После удаления пакета почта, отправляемая в почтовые ящики на локальном сервере Exchange Server, не копируется в соответствующие почтовые ящики Office 365:.
    
- Почтовые ящики Office 365: синхронизированы по крайней мере один раз после того, как почта стала доставляться непосредственно в них. Для этого убедитесь, что значение в поле "Время последней синхронизации" для пакета миграции позже даты и времени, когда почта стала направляться непосредственно в почтовые ящики Office 365:.
    
Чтобы удалить пакет миграции CutoverBatch в Exchange Online PowerShell, выполните следующую команду.
  
```
Remove-MigrationBatch -Identity CutoverBatch
```

### <a name="section-7-assign-user-licenses"></a>Шаг 7. Назначение пользователям лицензий
<a name="BK_Step7"> </a>

 **Активируйте учетные записи пользователей Office 365 для перенесенных учетных записей, назначив им лицензии.** Если вы не назначите лицензию, почтовый ящик отключается по окончании льготного периода (30 дней). Чтобы назначить лицензию в центре администрирования Microsoft 365, ознакомьтесь с разназначением[лицензий на Office 365 для бизнеса](https://go.microsoft.com/fwlink/?LinkId=536681).
  
### <a name="step-8-complete-post-migration-tasks"></a>Шаг 8. Необходимые действия после миграции
<a name="BK_Step8"> </a>

- **Создайте DNS-запись автообнаружения, чтобы пользователи смогли с легкостью получить доступ к своим почтовым ящикам.** После переноса всех локальных почтовых ящиков в Office 365: вы можете настроить DNS-запись автообнаружения для своей организации Office 365:, чтобы пользователи могли с легкостью подключаться к своим новым почтовым ящикам Office 365: с помощью Outlook и мобильных клиентов. В этой новой DNS-записи автообнаружения необходимо использовать то же пространство имен, которое используется для организации Office 365:. Например, если облачное пространство имен  cloud.contoso.com, необходимо создать DNS-запись автообнаружения autodiscover.cloud.contoso.com.
    
    Если Exchange Server останется, убедитесь, что после миграции запись CNAME службы доменных имен (DNS) для автообнаружения указывает на Office 365 на внутренних и внешних DNS-серверах, чтобы клиент Outlook мог подключиться к правильному почтовому ящику.
    
    > [!NOTE]
    >  В Exchange 2007, Exchange 2010 и Exchange 2013 для параметра  `Set-ClientAccessServer AutodiscoverInternalConnectionURI` необходимо задать значение `Null`. 
  
    В Office 365: запись CNAME служит для реализации службы автообнаружения для клиентов Outlook и мобильных клиентов. Необходимо, чтобы запись CNAME для автообнаружения содержала следующие сведения.
    
  - **Псевдоним:** autodiscover
    
  - **Целевой объект:** autodiscover.outlook.com
    
    Дополнительные сведения см. в статье [Создание DNS-записей для Office 365 при управлении DNS-записями](https://go.microsoft.com/fwlink/p/?LinkId=535028).
    
- **Выполните списание локальных серверов Exchange.** Как только вы убедитесь, что вся электронная почта направляется непосредственно в почтовые ящики Office 365:, поэтому вам больше не нужно поддерживать свою локальную организацию электронной почты, либо если вы не планируете внедрять решение единого входа, вы можете удалить Exchange с серверов, а также удалить свою локальную организацию Exchange.
    
    Дополнительные сведения см. в следующих статьях:
    
  - [Изменение или удаление Exchange 2010](https://go.microsoft.com/fwlink/?LinkId=217936)
    
  - [Удаление организации Exchange 2007](https://go.microsoft.com/fwlink/?LinkID=100485)
    
  - [Удаление сервера Exchange Server 2003](https://go.microsoft.com/fwlink/?LinkID=56561)
    

