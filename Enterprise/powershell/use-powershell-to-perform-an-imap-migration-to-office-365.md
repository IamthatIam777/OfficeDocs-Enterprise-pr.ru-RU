---
title: Использование PowerShell для миграции IMAP в Office 365
ms.author: josephd
author: JoeDavies-MSFT
manager: laurawi
ms.date: 12/15/2017
audience: Admin
ms.topic: article
ms.service: o365-administration
localization_priority: Normal
ms.collection: Ent_O365
f1.keywords:
- NOCSH
ms.custom: ''
ms.assetid: c28de4a5-1e8e-4491-9421-af066cde7cdd
description: Сводка. Узнайте, как использовать Windows PowerShell для миграции IMAP в Office 365.
ms.openlocfilehash: 271e8b235279d1661ba95ae75f070d8ce6d2496d
ms.sourcegitcommit: 99411927abdb40c2e82d2279489ba60545989bb1
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/07/2020
ms.locfileid: "41841286"
---
# <a name="use-powershell-to-perform-an-imap-migration-to-office-365"></a>Использование PowerShell для миграции IMAP в Office 365

В процессе развертывания Office 365:, вы можете перенести содержимое почтовых ящиков пользователей из службы электронной почты IMAP в Office 365:. В этой статье описаны задачи, которые выполняются при миграции электронной почты IMAP с помощью Exchange Online PowerShell. 
  
> [!NOTE]
> Для миграции IMAP можно также использовать Центр администрирования Exchange. См. статью [Перенос почтовых ящиков IMAP в Office 365](https://go.microsoft.com/fwlink/p/?LinkId=536685). 
  
## <a name="what-do-you-need-to-know-before-you-begin"></a>Что нужно знать перед началом работы?

Предполагаемое время выполнения задачи: от 2 до 5 минут для создания пакета миграции. После запуска пакета миграции продолжительность миграции будет зависеть от количества почтовых ящиков в пакете, размера каждого почтового ящика и доступной пропускной способности сети. Подробнее о других факторах, влияющих на продолжительность миграции почтовых ящиков в Office 365:, см. в статье [Производительность миграции](https://go.microsoft.com/fwlink/p/?LinkId=275079)
  
Для выполнения этой процедуры (процедур) необходимы соответствующие разрешения. Сведения о необходимых разрешениях см. в пункте "Миграция" статьи [Разрешения получателей](https://go.microsoft.com/fwlink/p/?LinkId=534105) в соответствующей таблице.
  
Чтобы использовать командлеты Exchange Online PowerShell, вам необходимо войти в систему и импортировать командлеты в локальный сеанс Windows PowerShell. Инструкции см в статье [Подключение к Exchange Online с помощью удаленной оболочки PowerShell](https://go.microsoft.com/fwlink/p/?LinkId=534121).
  
Полный список команд миграции см. в статье [Командлеты перемещения и миграции](https://go.microsoft.com/fwlink/p/?LinkId=534750).
  
К миграции IMAP применяются следующие ограничения.
  
- Можно перемещать только элементы из папки "Входящие" и других папок почты. Миграция контактов, элементов календаря и задач невозможна.
    
- Из почтового ящика пользователя можно перенести не более 500 000 элементов.
    
- Максимальный размер сообщения, которое можно перенести, равен 35 МБ.
    
## <a name="migration-steps"></a>Шаги миграции

### <a name="step-1-prepare-for-an-imap-migration"></a>Шаг 1. Подготовка к миграции IMAP
<a name="BK_Step1"> </a>

- **Если у организации IMAP есть домен, добавьте его в качестве обслуживаемого домена организации Office 365.** Если вы хотите использовать имеющийся домен для своих почтовых ящиков Office 365:, сначала его необходимо добавить в Office 365: в качестве обслуживаемого домена. После добавления вы можете создать пользователей в Office 365:. Дополнительные сведения см. в статье[Проверка домена в Office 365](https://go.microsoft.com/fwlink/p/?LinkId=534110).
    
- **Добавьте всех пользователей в Office 365:, чтобы у каждого из них был почтовый ящик Office 365:.** Инструкции см. в статье[Добавление пользователей в Office 365 для бизнеса](https://go.microsoft.com/fwlink/p/?LinkId=535065).
    
- **Получите полное доменное имя (FQDN) сервера IMAP**. Необходимо указать полное доменное имя (FQDN) (которое также называется полным именем компьютера) сервера IMAP, из которого будут переноситься данные почтовых ящиков при создании конечной точки миграции IMAP. С помощью клиента IMAP или команды PING убедитесь, что это имя можно использовать для подключения к серверу IMAP через Интернет.
    
- **Настройте брандмауэр, разрешив подключения IMAP**. Может потребоваться открыть порты в брандмауэре организации, в которой размещен сервер IMAP, чтобы сетевой трафик, исходящий из центра обработки данных корпорации Майкрософт во время миграции, смог поступать в организацию, в которой размещен сервер IMAP. Список IP-адресов, используемых центрами обработки данных корпорации Майкрософт, см. в статье [URL-адреса и диапазоны IP-адресов Office 365](https://go.microsoft.com/fwlink/p/?LinkId=535066).
    
- **Предоставьте учетной записи администратора разрешения на доступа к почтовым ящикам в организации IMAP**. Если в CSV-файле используются учетные данные администратора, применяемая учетная запись должна иметь необходимые разрешения на доступ к локальным почтовым ящикам. Разрешения, необходимые для доступа к почтовым ящикам пользователей, определяются конкретным сервером IMAP. 
    
- **Чтобы использовать командлеты Exchange Online PowerShell**, вам необходимо войти в систему и импортировать командлеты в локальный сеанс Windows PowerShell. Инструкции см в статье [Подключение к Exchange Online с помощью удаленной оболочки PowerShell](https://go.microsoft.com/fwlink/p/?LinkId=534121).
    
    Полный список команд миграции см. в статье [Командлеты перемещения и миграции](https://go.microsoft.com/fwlink/p/?LinkId=534750).
    
- **Убедитесь, что вы можете подключиться к серверу IMAP**. Выполните следующую команду в Exchange Online PowerShell, чтобы проверить параметры подключения к серверу IMAP.
    
  ```powershell
  Test-MigrationServerAvailability -IMAP -RemoteServer <FQDN of IMAP server> -Port <143 or 993> -Security <None, Ssl, or Tls>
  ```

    Для параметра **Port** обычно устанавливается значение 143 для незашифрованных или TLS-соединений и значение 993 для SSL-соединений.
    
### <a name="step-2-create-a-csv-file-for-an-imap-migration-batch"></a>Шаг 2. Создание CSV-файла для пакета миграции IMAP.
<a name="BK_Step2"> </a>

Определите группу пользователей, миграцию чьих почтовых ящиков следует выполнить с помощью пакета миграции IMAP. Каждая строка в CSV-файле содержит сведения, необходимые для подключения к почтовому ящику в системе обмена сообщениями IMAP.
  
Ниже приведены обязательные атрибуты для каждого пользователя. 
  
- **EmailAddress**. Задает идентификатор пользователя для его почтового ящика Office 365:.
    
- **UserName**. Задает для учетной записи имя для входа, при помощи которого будет выполняться доступ к почтовому ящику на сервере IMAP.
    
- **Password**. Задает пароль для учетной записи в столбце **UserName**.
    
Ниже приведен пример формата CSV-файла. В этом примере выполняется миграция трех почтовых ящиков.
  
```powershell
EmailAddress,UserName,Password
terrya@contoso.edu,terry.adams,1091990
annb@contoso.edu,ann.beebe,2111991
paulc@contoso.edu,paul.cannon,3281986
```

В качестве значения атрибута **UserName** кроме имени пользователя можно использовать данные учетной записи, для которой назначены необходимые разрешения на доступ к почтовым ящикам на сервере IMAP. Ниже перечислены несколько специальных форматов, используемых для некоторых серверов IMAP.
  
 **Microsoft Exchange**
  
При переносе электронной почты с реализации IMAP в Microsoft Exchange для атрибута **UserName** в CSV-файле используется формат **домен/имя_администратора/имя_пользователя**. Предположим, выполняется перенос электронной почты Exchange для учетных записей Terry Adams, Ann Beebe и Chris Cannon. Имеется учетная запись администратора почты с именем пользователя **mailadmin** и паролем **P@ssw0rd**. Вот как будет выглядеть CSV-файл.
  
```powershell
EmailAddress,UserName,Password
terrya@contoso.edu,contoso-students/mailadmin/terry.adams,P@ssw0rd
annb@contoso.edu,contoso-students/mailadmin/ann.beebe,P@ssw0rd
paulc@contoso.edu,contoso-students/mailadmin/paul.cannon,P@ssw0rd
```

 **Dovecot**
  
На серверах IMAP, поддерживающих протокол SASL, например Dovecot, используется формат **имя_пользователя*имя_администратора**, где звездочка (*) является настраиваемым знаком разделения. Допустим, переносится почта тех же пользователей с сервера IMAP Dovecot с использованием учетных данных администратора **mailadmin** и **P@ssw0rd**. Вот как будет выглядеть CSV-файл:
  
```powershell
EmailAddress,UserName,Password
terrya@contoso.edu,terry.adams*mailadmin,P@ssw0rd
annb@contoso.edu,ann.beebe*mailadmin,P@ssw0rd
paulc@contoso.edu,paul.cannon*mailadmin,P@ssw0rd
```

 **Mirapoint**
  
При переносе почты с сервера Mirapoint Message Server для учетных данных администратора используется формат **#пользователь@домен#имя_администратора#**. Для переноса электронной почты с Mirapoint с использованием учетных данных администратора **mailadmin** и **P@ssw0rd** CSV-файл должен выглядеть следующим образом.
  
```powershell
EmailAddress,UserName,Password
terrya@contoso.edu,#terry.adams@contoso-students.edu#mailadmin#,P@ssw0rd
annb@contoso.edu,#ann.beebe@contoso-students.edu#mailadmin#,P@ssw0rd
paulc@contoso.edu,#paul.cannon@contoso-students.edu#mailadmin#,P@ssw0rd
```

 **Courier-IMAP**
  
Некоторые исходные системы электронной почты, такие как Courier IMAP, не поддерживают использование учетных данных администратора почтовых ящиков для переноса почтовых ящиков в Office 365:. В таком случае исходную систему электронной почты необходимо настроить на использование виртуальных общих папок. С помощью виртуальных общих папок вы можете использовать учетные данные администратора почтовых ящиков для доступа к почтовым ящикам пользователей в исходной системе электронной почты. Дополнительные сведения о настройке виртуальных общих папок для Courier IMAP см. в статье [Общие папки](https://go.microsoft.com/fwlink/p/?LinkId=398870).
  
Чтобы перенести почтовые ящики после настройки виртуальных общих папок в исходной системе электронной почты, в файл миграции необходимо включить необязательный атрибут **UserRoot**. Этот атрибут определяет расположение каждого пользовательского почтового ящика в структуре виртуальных общих папок в исходной системе электронной почты. Например, путь к почтовому ящику пользователя Terry  /users/terry.adams.
  
Ниже приведен пример CSV-файла, содержащего атрибут **UserRoot**.
  
```powershell
EmailAddress,UserName,Password,UserRoot
terrya@contoso.edu,mailadmin,P@ssw0rd,/users/terry.adams
annb@contoso.edu,mailadmin,P@ssw0rd,/users/ann.beebe
paulc@contoso.edu,mailadmin,P@ssw0rd,/users/paul.cannon
```

### <a name="step-3-create-an-imap-migration-endpoint"></a>Шаг 3. Создание конечной точки миграции IMAP
<a name="BK_Step3"> </a>

Для успешного переноса электронной почты решение Office 365: должно обмениваться данными с исходной системой электронной почты. Для этого в Office 365: используется конечная точка миграции. Конечная точка миграции также определяет количество почтовых ящиков для одновременной миграции и для одновременной синхронизации в процессе добавочной синхронизации, которая осуществляется один раз каждые 24 часа. Чтобы создать конечную точку миграции IMAP, сначала [подключитесь к Exchange Online](https://go.microsoft.com/fwlink/p/?LinkId=534121). 
  
Полный список команд миграции см. в статье [Командлеты перемещения и миграции](https://go.microsoft.com/fwlink/p/?LinkId=534750).
  
Чтобы создать конечную точку миграции IMAP с именем IMAPEndpoint в Exchange Online PowerShell, выполните следующую команду.
  
```powershell
New-MigrationEndpoint -IMAP -Name IMAPEndpoint -RemoteServer imap.contoso.com -Port 993 -Security Ssl

```

Вы также можете добавить параметры, чтобы указать одновременно выполняемые миграции (в том числе добавочные) и используемый порт. Следующая команда Exchange Online PowerShell создает конечную точку миграции IMAP с именем IMAPEndpoint, которая поддерживает 50 одновременных миграций и до 25 одновременных добавочных синхронизаций. В этом примере конечная точка также настраивается на использование порта 143 для шифрования TLS.
  
```powershell
New-MigrationEndpoint -IMAP -Name IMAPEndpoint -RemoteServer imap.contoso.com -Port 143 -Security Tls -MaxConcurrentMigrations
50 -MaxConcurrentIncrementalSyncs 25
```

Дополнительные сведения о командлете **New-MigrationEndpoint** см. в статье[New-MigrationEndpoint](https://go.microsoft.com/fwlink/p/?LinkId=536437).
  
#### <a name="verify-it-worked"></a>Проверка работы

Выполните следующую команду в Exchange Online PowerShell, чтобы отобразить сведения о конечной точке миграции IMAPEndpoint.
  
```powershell
Get-MigrationEndpoint IMAPEndpoint | Format-List EndpointType,RemoteServer,Port,Security,Max*
```

### <a name="step-4-create-and-start-an-imap-migration-batch"></a>Шаг 4. Создание и запуск пакета миграции IMAP
<a name="BK_Step4"> </a>

Для создания пакета миграции IMAP можно использовать командлет [New-MigrationBatch](https://go.microsoft.com/fwlink/p/?LinkId=536439). Можно создать пакет миграции и запустить его обработку автоматически, включив параметр  _AutoStart_. Кроме того, вы можете создать пакет миграции и запустить его с помощью командлета [Start-MigrationBatch](https://go.microsoft.com/fwlink/p/?LinkId=536440).
  
Следующая команда Exchange Online PowerShell автоматически запустит пакет миграции IMAPBatch1 с использованием конечной точки IMAP с именем IMAPEndpoint.
  
```powershell
New-MigrationBatch -Name IMAPBatch1 -SourceEndpoint IMAPEndpoint -CSVData ([System.IO.File]::ReadAllBytes("C:\Users\Administrator\Desktop\IMAPmigration_1.csv")) -AutoStart
```

#### <a name="verify-it-worked"></a>Проверка работы

Выполните командлет [Get-MigrationBatch](https://go.microsoft.com/fwlink/p/?LinkId=536441), чтобы отобразить сведения о пакете миграции IMAPBatch1.
  
```powershell
Get-MigrationBatch -Identity IMAPBatch1 | Format-List
```

Вы также можете убедиться, что пакет запущен, выполнив следующую команду.
  
```powershell
Get-MigrationBatch -Identity IMAPBatch1 | Format-List Status
```

### <a name="step-5-route-your-email-to-office-365"></a>Шаг 5. Маршрутизация электронной почты в Office 365
<a name="BK_Step5"> </a>

Чтобы выяснить, куда доставлять сообщения электронной почты, системы электронной почты используют DNS-запись, которая называется записью MX. В процессе миграции электронной почты запись MX указывала на вашу исходную систему электронной почты. Теперь, когда перенос электронной почты в Office 365: завершен, запись MX должна указывать на Office 365:. Это обеспечит доставку электронной почты в ваши почтовые ящики Office 365:. Перемещая запись MX, вы также сможете отключить старую систему электронной почты, когда будете готовы сделать это. 
  
Для многих поставщиков DNS предоставляются отдельные инструкции по изменению записей MX. Если ваш поставщик DNS не включен или вы хотите понять общие указания, также предоставляются [Общие инструкции MX Record](https://go.microsoft.com/fwlink/?LinkId=397449) .
  
Системам электронной почты клиентов и партнеров может потребоваться до 72 часов, чтобы распознать измененную запись MX. Подождите по крайней мере 72 часа, прежде чем перейти к следующей задаче: Шаг 6. Удаление пакета миграции IMAP. 
  
### <a name="step-6-delete-imap-migration-batch"></a>Шаг 6. Удаление пакета миграции IMAP
<a name="BK_Step6"> </a>

После того как вы измените запись MX и убедитесь, что вся электронная почта направляется в почтовые ящики Office 365:, уведомите пользователей о том, что их сообщения доставляются в Office 365. Затем можно удалить пакет миграции IMAP. Убедитесь в следующем, прежде чем удалить пакет миграции.
  
- Все пользователи используют почтовые ящики Office 365:. После удаления пакета почта, отправляемая в почтовые ящики на локальном сервере Exchange Server, не копируется в соответствующие почтовые ящики Office 365:.
    
- Почтовые ящики Office 365: синхронизированы по крайней мере один раз после того, как почта стала доставляться непосредственно в них. Для этого убедитесь, что значение в поле "Время последней синхронизации" для пакета миграции позже даты и времени, когда почта стала направляться непосредственно в почтовые ящики Office 365:.
    
Чтобы удалить пакет миграции IMAPBatch1 в Exchange Online PowerShell, выполните следующую команду.
  
```powershell
Remove-MigrationBatch -Identity IMAPBatch1
```

Дополнительные сведения о командлете **Remove-MigrationBatch** см. в статье[Remove-MigrationBatch](https://go.microsoft.com/fwlink/p/?LinkId=536481).
  
#### <a name="verify-it-worked"></a>Проверка работы

Выполните следующую команду в Exchange Online PowerShell, чтобы отобразить сведения о пакете миграции IMAPBatch1.
  
```powershell
Get-MigrationBatch IMAPBatch1"
```

Команда либо вернет пакет миграции с состоянием **Удаление**, либо вернет ошибку (не удалось найти пакет миграции), что подтверждает удаление пакета миграции.
  
Дополнительные сведения о командлете **Get-MigrationBatch** см. в статье[Get-MigrationBatch](https://go.microsoft.com/fwlink/p/?LinkId=536441).
  
## <a name="see-also"></a>См. также

[Средство устранения неполадок миграции IMAP](https://go.microsoft.com/fwlink/p/?LinkId=536482)

