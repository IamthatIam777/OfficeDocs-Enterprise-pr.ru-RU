---
title: "Использование службы Microsoft Azure Active Directory для проверки подлинности в SharePoint 2013"
ms.author: josephd
author: JoeDavies-MSFT
manager: laurawi
ms.date: 12/15/2017
ms.audience: ITPro
ms.topic: article
ms.service: o365-solutions
localization_priority: Normal
ms.collection: Ent_O365
ms.custom: Ent_Solutions
ms.assetid: bef810a4-53f6-4962-878e-e20b5019baeb
description: "Сводка. Узнайте, как использовать службу контроля доступа Azure для проверки подлинности пользователей SharePoint Server 2013 в Azure Active Directory."
ms.openlocfilehash: 9025eb53f4d8e37403c48416f41adbe35fa9fa01
ms.sourcegitcommit: 9f1fe023f7e2924477d6e9003fdc805e3cb6e2be
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/11/2018
---
# <a name="using-microsoft-azure-active-directory-for-sharepoint-2013-authentication"></a>Использование службы Microsoft Azure Active Directory для проверки подлинности в SharePoint 2013

 **Сводка.** Узнайте, как использовать службу контроля доступа Azure для проверки подлинности пользователей SharePoint Server 2013 в Azure Active Directory.
  
Управлять пользователями может быть проще, если они будут проходить проверку подлинности у разных поставщиков удостоверений. Подумайте, насколько удобно может быть использовать надежного поставщика удостоверений, которым управляет кто-то другой. Например, вы можете использовать один тип проверки подлинности для пользователей, которые получают доступ к SharePoint Server 2013 в облаке, а другой  для пользователей SharePoint 2013 в локальной среде. Служба контроля доступа Azure делает возможным этот выбор. 
  
В этой статье описано, как можно использовать службу контроля доступа Azure для проверки подлинности пользователей SharePoint 2013 в службе Azure AD, а не в локальной службе Active Directory. В этой конфигурации Azure AD становится доверенным поставщиком удостоверений для SharePoint 2013. При этом добавляется метод аутентификации пользователей, отличный от проверки подлинности Active Directory, которую использует установленный экземпляр SharePoint 2013. Эта статья будет вам полезна, если вы знакомы с WS-Federation. Дополнительные сведения см. в статье [Общие сведения о WS-Federation](https://go.microsoft.com/fwlink/p/?linkid=188052).
  
На следующем рисунке показано, как работает проверка подлинности для пользователей SharePoint 2013 в этой конфигурации.
  
![Пользователи, прошедшие проверку подлинности в Azure Active Directory](images/SP_AzureAD.png)
  
Пример, используемый в этой статье, предоставил Кирк Эванс (Kirk Evans), архитектор Майкрософт из центра подготовки по Azure. 
  
Сведения о специальных возможностях SharePoint 2013 см. в статье [Специальные возможности в SharePoint 2013](https://go.microsoft.com/fwlink/p/?LinkId=393123).
  
## <a name="configuration-overview"></a>Общие сведения о конфигурации

Выполните приведенные ниже основные действия, чтобы настроить среду для использования Azure AD в качестве поставщика удостоверений SharePoint 2013.
  
1. Создайте клиент и пространство имен Azure AD.
    
2. Добавьте поставщика удостоверений WS-Federation.
    
3. Добавьте SharePoint в качестве приложения проверяющей стороны.
    
4. Создайте самозаверяющий SSL-сертификат.
    
5. Создайте группу правил для проверки подлинности на основе утверждений.
    
6. Настройте сертификат X.509.
    
7. Создайте сопоставление утверждений.
    
8. Настройте SharePoint для нового поставщика удостоверений.
    
9. Задайте разрешения.
    
10. Проверьте нового поставщика.
    
## <a name="create-azure-ad-tenant-and-namespace"></a>Создание клиента и пространства имен Azure AD

Выполните указанные ниже действия, чтобы создать клиент Azure AD и связанное с ним пространство имен. В нашем примере используется пространство имен blueskyabove 
  
1. На портале управления Azure выберите **Active Directory** и создайте клиент Azure AD.
    
2. Нажмите **Пространства имен Access Control** и создайте новое пространство имен. 
    
3. Нажмите кнопку **Управление** в нижней панели. Должен открыться следующий адрес: https://blueskyabove.accesscontrol.windows.net/v2/mgmt/web.
    
4. Откройте командную консоль Windows PowerShell. Используйте модуль Microsoft Online Services для Windows PowerShell, который необходим, чтобы установить Azure для командлетов Windows PowerShell.
    
5. В командной строке Windows PowerShell введите команду  `Connect-Msolservice` и свои учетные данные.
    
    > [!NOTE]
    > Дополнительные сведения об использовании Azure для командлетов Windows PowerShell см. в статье [Управление службой Azure AD с помощью Windows PowerShell](https://go.microsoft.com/fwlink/p/?LinkId=393124). 
  
6. В командной строке Windows PowerShell введите следующие команды:
    
  ```
  Import-Module MSOnlineExtended -Force
  ```

  ```
  $replyUrl = New-MsolServicePrincipalAddresses -Address "https://blueskyabove.accesscontrol.windows.net/"
  ```

  ```
  New-MsolServicePrincipal -ServicePrincipalNames @("https://blueskyabove.accesscontrol.windows.net/") -DisplayName "BlueSkyAbove ACS Namespace" -Addresses $replyUrl
  ```

    На следующем рисунке показан результат вывода команды.
    
     ![Создание имен субъектов-служб](images/ServicePrincipalNames.jpg)
  
## <a name="add-a-ws-federation-identity-provider-to-the-namespace"></a>Добавление поставщика удостоверений WS-Federation к пространству имен

Выполните указанные ниже действия, чтобы добавить поставщика удостоверений WS-Federation к пространству имен blueskyabove.
  
1. На портале управления Azure перейдите в раздел **Active Directory** > **Пространства имен Access Control Namespaces**, нажмите **Создать новый экземпляр**, а затем нажмите кнопку **Управление**.
    
2. На портале Azure Access Control выберите команды **Поставщики удостоверений** > **Добавить**, как показано на следующем рисунке.
    
     ![Диалоговое окно "Поставщики удостоверений" в Azure](images/Identity.jpg)
  
3. Выберите пункт **Поставщик удостоверений WS-Federation**, как показано на следующем рисунке, а затем нажмите кнопку **Далее**.
    
     ![Параметры команды "Добавить поставщика удостоверений" в Azure](images/AddIdentity.jpg)
  
4. Введите отображаемое имя и текст ссылки для входа, а затем нажмите кнопку **Сохранить**. В качестве URL-адреса метаданных WS-Federation введите https://accounts.accesscontrol.windows.net/blueskyabove.onmicrosoft.com/FederationMetadata/2007-06/FederationMetadata.xml. Этот параметр показан на следующем рисунке.
    
     ![Поставщик удостоверений федерации](images/FederationIdentity.jpg)
  
## <a name="add-sharepoint-as-a-relying-party-application"></a>Добавление SharePoint в качестве приложения проверяющей стороны

Выполните указанные ниже действия, чтобы добавить SharePoint в качестве приложения проверяющей стороны.
  
Дополнительные сведения о параметрах приложений проверяющей стороны см. в статье [Приложения проверяющей стороны](https://go.microsoft.com/fwlink/p/?LinkId=393125).
  
1. На портале Azure Access Control выберите пункт **Приложения проверяющей стороны** и нажмите кнопку **Добавить**, как показано на следующем рисунке.
    
     ![Настройки приложения проверяющей стороны](images/RelyingPartyApplications.jpg)
  
## <a name="create-a-self-signed-certificate-to-use-for-ssl"></a>Создание самозаверяющего сертификата для SSL

Выполните указанные ниже действия, чтобы создать самозаверяющий сертификат для безопасного подключения по SSL.
  
1. Расширьте веб-приложение, чтобы оно использовало тот же URL-адрес, что и PublishingSite, но используйте SSL с портом 443, как показано на следующем рисунке.
    
     ![Параметры для расширения приложения](images/ExtendWebApp.jpg)
  
2. В Диспетчер IIS дважды щелкните **Сертификаты сервера**.
    
3. В области **Действия** нажмите **Создать самозаверяющий сертификат**. Введите понятное имя сертификата в поле **Понятное имя сертификата** и нажмите кнопку **ОК**.
    
4. В диалоговом окне **Изменение привязки сайта** убедитесь, что имя узла совпадает с понятным именем, как показано на следующих рисунках.
    
     ![Мастер самозаверяющих сертификатов](images/SelfSignedCert.jpg)
  
     ![Имя сервера в диалоговом окне "Изменить привязки"](images/SelfSignedCert1.jpg)
  
5. На портале управления Azure щелкните виртуальную машину, которую нужно настроить, и выберите пункт **Конечные точки**.
    
6. Нажмите кнопку **Добавить**, а затем  кнопку **-->** ("Далее").
    
7. В поле **Имя** введите имя конечной точки.
    
8. В полях **Общий порт** и **Частный порт** введите нужные номера портов и щелкните флажок, чтобы завершить настройку. Эти номера могут отличаться. В этой статье используется порт 443, как показано на следующем рисунке.
    
     ![Настройки конечной точки в Azure](images/AddEndpoint.jpg)
  
    > [!NOTE]
    > Дополнительные сведения о добавлении конечной точки к виртуальной машине в Azure см. в статье [Настройка конечных точек виртуальной машины](https://go.microsoft.com/fwlink/p/?LinkId=393126). 
  
9. На портале служб Access Control добавьте проверяющую сторону, как показано на следующем рисунке.
    
     ![Параметры добавления проверяющей стороны в приложении](images/AddRelyingParty.jpg)
  
## <a name="create-a-rule-group-for-claims-based-authentication"></a>Создание группы правил для проверки подлинности на основе утверждений

Выполните указанные ниже действия, чтобы создать группу правил для проверки подлинности на основе утверждений.
  
1. В левой области выберите **Группы правил** и нажмите кнопку **Добавить**.
    
2. Введите имя группы правил, нажмите кнопку **Сохранить**, а затем  кнопку **Создать**. В этой статье используется **Default Rule Group for. spvms.cloudapp.net**, как показано на следующем рисунке.
    
     ![Параметры группы правил в Azure](images/RuleGroup.jpg)
  
     ![Правила после выбора команды "Создать"](images/GenerateRules.jpg)
  
    > [!NOTE]
    > Дополнительные сведения о создании групп правил см. в статье [Группы правил и правила](https://go.microsoft.com/fwlink/p/?LinkId=393128). 
  
3. Щелкните нужную группу правил, а затем выберите нужное правило утверждений. В этой статье мы добавим в группу правило утверждений, которое передает параметр **name** как **upn**, как показано на следующем рисунке.
    
     ![Правила утверждений в службе Azure Access Control](images/ClaimRules.jpg)
  
4. Удалите существующее правило утверждений под названием **upn** и оставьте правило **Name Claim to UPN**, как показано на следующем рисунке.
    
     ![Параметры правил утверждений в службе Azure Access Control](images/ClaimToUPN.jpg)
  
## <a name="configure-the-x509-certificate"></a>Настройка сертификата X.509

Выполните указанные ниже действия, чтобы настроить сертификат X.509 для использования подписей маркеров.
  
1. В области службы контроля доступа в разделе **Разработка** выберите пункт **Интеграция приложений**.
    
2. В разделе **Ссылка на конечную точку** найдите файл **Federation.xml**, связанный с клиентом Azure, и скопируйте расположение из адресной строки браузера.
    
3. В файле **Federation.xml** найдите раздел **RoleDescriptor** и скопируйте сведения из элемента _<X509Certificate>_, как показано на следующем рисунке.
    
     ![Элемент сертификата X509 в файле Federation.xml](images/X509Cert.jpg)
  
4. В корне диска C:\\ создайте папку под названием **Certificates**.
    
5. Сохраните файл сведений X509Certificate в папке C:\\Certificates под именем **AcsTokenSigning.cer**.
    
    > [!NOTE]
    > Имя файла должно иметь расширение CER. 
  
     ![Сохранение элемента X509Certificate в файле](images/X509Cert_Save.jpg)
  
## <a name="create-a-claim-mapping-by-using-windows-powershell"></a>Создание сопоставления утверждений с помощью Windows PowerShell

Выполните указанные ниже действия, чтобы создать сопоставление утверждений с помощью Windows PowerShell.
  
Убедитесь, что вы являетесь участником следующих групп:
  
1. Предопределенная роль сервера **securityadmin** для экземпляра SQL Server.
    
2. Предопределенная роль сервера **db_owner** на всех обновляемых базах данных.
    
3. Группа администраторов сервера, на котором выполняются командлеты Windows PowerShell.
    
Администратор может использовать командлет **Add-SPShellAdmin** для предоставления разрешений на использование командлетов SharePoint 2013.
  
> [!NOTE]
> Если у вас нет разрешений, запросите их у администратора установки или администратора SQL Server. Дополнительные сведения о разрешениях Windows PowerShell см. в описании командлета [Add-SPShellAdmin]((http://technet.microsoft.com/library/2ddfad84-7ca8-409e-878b-d09cb35ed4aa.aspx)). 
  
1. В меню **Пуск** выберите пункт **Все программы**.
    
2. Выберите **Продукты Microsoft SharePoint 2013**.
    
3. Щелкните **Командная консоль Командная консоль SharePoint 2013**.
    
4. В командной строке Windows PowerShell введите следующие команды, чтобы создать сопоставление утверждений:
    
  ```
  $cert = New-Object System.Security.Cryptography.X509Certificates.X509Certificate2("c:\\certificates\\AcsTokenSigning.cer")
  ```

  ```
  New-SPTrustedRootAuthority -Name "ACS BlueSkyAbove Token Signing" -Certificate $cert
  ```

  ```
  $map = New-SPClaimTypeMapping -IncomingClaimType "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/upn" -IncomingClaimTypeDisplayName "UPN" -SameAsIncoming
  ```

  ```
  $map2 = New-SPClaimTypeMapping -IncomingClaimType "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/givenname" -IncomingClaimTypeDisplayName "GivenName" -SameAsIncoming
  ```

  ```
  $map3 = New-SPClaimTypeMapping -IncomingClaimType "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/surname" -IncomingClaimTypeDisplayName "SurName" -SameAsIncoming
  ```

  ```
  $realm = "urn:sharepoint:spvms"
  ```

  ```
  $ap = New-SPTrustedIdentityTokenIssuer -Name "ACS Provider" -Description "SharePoint secured by SAML in ACS" -realm $realm -ImportTrustCertificate $cert -ClaimsMappings $map,$map2,$map3 -SignInUrl "https://blueskyabove.accesscontrol.windows.net/v2/wsfederation" -IdentifierClaim "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/upn"
  ```

## <a name="configure-sharepoint-for-the-new-identity-provider"></a>Настройка SharePoint для нового поставщика удостоверений

Выполните указанные ниже действия, чтобы настроить свою установку SharePoint для нового поставщика удостоверений Azure AD.
  
1. Проверьте, является ли учетная запись пользователя, с помощью которой выполняется данная процедура, участником группы администраторов фермы SharePoint.
    
2. На домашней странице центра Центр администрирования нажмите **Управление приложениями**.
    
3. На странице **Управление приложениями** в разделе **Веб-приложения** щелкните **Управление веб-приложениями**.
    
4. Щелкните соответствующее веб-приложение.
    
5. Нажмите на ленте кнопку **Поставщики проверки подлинности**.
    
6. В разделе **Зона** щелкните имя зоны, например **По умолчанию**.
    
7. На странице **Изменение параметров проверки подлинности** в разделе **Типы проверки подлинности на основе утверждений** выберите пункт **Доверенный поставщик удостоверений**, а затем щелкните имя своего поставщика (в этой статье  **ACS Provider** ). Нажмите кнопку **ОК**.
    
8. На следующем рисунке показан параметр **Trusted Provider**.
    
![Параметр "Надежный поставщик" в веб-приложении](images/AddProvider_Azure.jpg)
  
## <a name="set-the-permissions"></a>Задание разрешений

Выполните указанные ниже действия, чтобы задать разрешения доступа к веб-приложению.
  
1. На главной странице Центр администрирования нажмите **Управление приложениями**.
    
2. На странице **Управление приложениями** в разделе **Веб-приложения** выберите команду **Управление веб-приложениями**.
    
3. Щелкните соответствующее веб-приложение, а затем выберите пункт **Политика пользователей**.
    
4. В разделе **Политика для веб-приложения** нажмите кнопку **Добавить пользователей**.
    
5. В диалоговом окне **Добавление пользователей** щелкните соответствующие зоны в разделе **Зоны**, а затем нажмите кнопку **Далее**.
    
6. В диалоговом окне **Добавление пользователей** введитеuser2@blueskyabove.onmicrosoft.com (ACS Provider).
    
7. В разделе **Разрешения** выберите **Полный доступ**.
    
8. Нажмите **Готово**, а затем  **ОК**.
    
На следующем рисунке показан раздел **Добавление пользователей** существующего веб-приложения.
  
![Добавление пользователей в существующее веб-приложение](images/AddUsers_Azure.jpg)
  
## <a name="verify-the-new-provider"></a>Проверка нового поставщика

Выполните указанные ниже действия, чтобы проверить работу поставщика удостоверений, убедившись, что новый поставщик удостоверений отображается в запросе входа.
  
1. Выполните вход с использованием нового поставщика под названием **Blue Sky Above**, как показано на следующем рисунке.
    
     ![Диалоговое окно входа с новым надежным поставщиком](images/BlueSkyAbove.jpg)
  
## <a name="additional-resources"></a>Дополнительные ресурсы

[Общие сведения о WS-Federation](https://go.microsoft.com/fwlink/p/?linkid=188052)
  
[Освоение облака и гибридные решения](cloud-adoption-and-hybrid-solutions.md)
  
## <a name="join-the-discussion"></a>Присоединяйтесь к обсуждению

|**Свяжитесь с нами**|**Описание**|
|:-----|:-----|
|**Какое вам решение необходимо?** <br/> |Мы создаем контент для решений, которые охватывают несколько продуктов и служб Майкрософт. Сообщите нам, что вы думаете о наших межсерверных решениях, или укажите интересующие вас решения, написав по адресу [MODAcontent@microsoft.com](mailto:cloudadopt@microsoft.com?Subject=[Cloud%20Adoption%20Content%20Feedback]:%20).<br/> |
|**Присоединяйтесь к обсуждению решений** <br/> |Если вам интересны облачные решения, присоединяйтесь к теме Cloud Adoption Advisory Board (CAAB) и общайтесь с разработчиками контента Майкрософт, специалистами отрасли и клиентами со всего мира. Чтобы присоединиться, добавьте себя в качестве участника [темы CAAB (Cloud Adoption Advisory Board)]((https://aka.ms/caab)) на сайте Microsoft Tech Community и отправьте нам письмо на адрес [CAAB@microsoft.com](mailto:caab@microsoft.com?Subject=I%20just%20joined%20the%20Cloud%20Adoption%20Advisory%20Board!). Просматривать материалы в [блоге CAAB]((https://blogs.technet.com/b/solutions_advisory_board/)) могут все пользователи. Однако только участники CAAB получают приглашения на закрытые вебинары, на которых мы рассказываем о новых облачных решениях и ресурсах по их внедрению.<br/> |
|**Скачать изображения, которые вы видите здесь** <br/> |Если вам нужна редактируемая копия иллюстративного материала из этой статьи, мы с радостью вам ее отправим. Напишите нам, указав URL-адрес и название материала, по адресу [cloudadopt@microsoft.com](mailto:cloudadopt@microsoft.com?subject=[Art%20Request]:%20).<br/> |
   

