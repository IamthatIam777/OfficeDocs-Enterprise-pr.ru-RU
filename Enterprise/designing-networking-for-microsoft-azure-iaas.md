---
title: Проектирование сети для Microsoft Azure IaaS
ms.author: josephd
author: JoeDavies-MSFT
manager: laurawi
ms.date: 11/28/2018
audience: ITPro
ms.topic: conceptual
ms.service: o365-solutions
localization_priority: Normal
search.appverid:
- MET150
ms.collection: Ent_O365
ms.custom: Ent_Architecture
ms.assetid: 9cb70c9d-9ed9-47cc-af5a-6403d87d3372
description: Сводка. Узнайте, как разрабатывать оптимизированную сеть для рабочих нагрузок в Microsoft Azure IaaS.
ms.openlocfilehash: b06564c8a86c59dac4ac9a5380cd88cf9d045974
ms.sourcegitcommit: 08e1e1c09f64926394043291a77856620d6f72b5
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/15/2019
ms.locfileid: "34068135"
---
# <a name="designing-networking-for-microsoft-azure-iaas"></a>Проектирование сети для Microsoft Azure IaaS

 **Сводка:** Узнайте, как разрабатывать оптимизированную сеть для рабочих нагрузок в Microsoft Azure IaaS.
  
Оптимизация сетей для выполнения ИТ-задач в Azure IaaS требует понимания виртуальных сетей, пространств адресов, маршрутизации, DNS и балансировки нагрузки Azure.
  
## <a name="planning-steps-for-any-vnet"></a>Этапы планирования для любой виртуальной сети

Ниже перечислены шаги, которыми следует руководствоваться при планировании виртуальной сети любого типа.
  
### <a name="step-1-prepare-your-intranet-for-microsoft-cloud-services"></a>Шаг 1. Подготовьте интрасеть для облачных служб (Майкрософт).

Выполните **действия по подготовке сети для облачных служб (Майкрософт)**, описанные в статье [Общие элементы подключения к облаку Майкрософт](common-elements-of-microsoft-cloud-connectivity.md).
  
### <a name="step-2-optimize-your-internet-bandwidth"></a>Шаг 2. Оптимизируйте пропускную способность канала доступа в Интернет.

Оптимизируйте скорость интернет-соединения, выполнив действия 2–4 из раздела **Действия по подготовке сети для служб Microsoft SaaS** статьи [Проектирование сети для Microsoft SaaS](designing-networking-for-microsoft-saas.md).
  
### <a name="step-3-determine-the-type-of-vnet-cloud-only-or-cross-premises"></a>Шаг 3. Выберите тип виртуальной сети (только облачная или распределенная).

Только облачные сети не подключаются к локальным сетям. Пример:
  
**Рис. 1. Только облачная виртуальная сеть**

![Рисунок 1: только облачная виртуальная сеть в Azure](media/8be19104-02b3-4a7f-b0a0-30d6fcf8890b.png)
  
На рисунке 1 показан набор виртуальных машин в только облачной виртуальной сети.
  
В распределенной виртуальной сети имеется подключение VPN типа "сеть-сеть" или ExpressRoute к локальной сети через шлюз Azure. Пример:
  
**Рис. 2. Распределенная виртуальная сеть**

![Рисунок 2: локальная виртуальная сеть в Azure](media/caacf007-e0dc-45d3-9531-441109776d25.png)
  
На рисунке 2 представлен набор виртуальных машин в распределенной виртуальной сети, которая подключена к локальной сети.
  
Дополнительные сведения см. в разделе [Этапы планирования для распределенной виртуальной сети](designing-networking-for-microsoft-azure-iaas.md#cross_prem) далее в этой статье.
  
### <a name="step-4-determine-the-address-space-of-the-vnet"></a>Шаг 4. Определите адресное пространство для виртуальной сети.

В таблице 1 показаны адресные пространства для различных типов виртуальных сетей.
  
|**Тип виртуальной сети**|**Адресное пространство виртуальной сети**|
|:-----|:-----|
|Только облако  <br/> |Произвольное частное адресное пространство  <br/> |
|Только облачная с межсоединениями  <br/> |Произвольный частный, но не перекрывающиеся с другими подключенными виртуальных сетей  <br/> |
|Распределенная  <br/> |Частное адресное пространство, не перекрывающееся с локальными сетями  <br/> |
|Распределенная с межсоединениями  <br/> |Частное адресное пространство, не перекрывающееся с другими локальными сетями и другими подключенными виртуальными сетями  <br/> |
   
 **Таблица 1. Типы виртуальных сетей и соответствующие адресные пространства**
  
Виртуальным машинам назначаются конфигурации адресов из адресного пространства подсети. За это отвечает сервер DHCP:
  
- Адрес/маска подсети
    
- Шлюз по умолчанию
    
- IP-адреса DNS-серверов
    
Кроме того, можно зарезервировать статический IP-адрес.
  
Виртуальным машинам также можно назначать общедоступные IP-адреса. Это можно сделать как отдельно для каждой машины, так и из облачной службы, содержащей виртуальные машины (только для машин, развернутых классическим способом).
  
### <a name="step-5-determine-the-subnets-within-the-vnet-and-the-address-spaces-assigned-to-each"></a>Шаг 5. Определите подсети в виртуальной сети и назначьте адресное пространство каждой из них.

В виртуальных сетях существует два типа подсетей: подсеть шлюза и подсеть с размещенными виртуальными машинами.
  
**Рис. 3. Два типа подсетей в Azure**

![Рис. 3. Два типа подсетей в Azure](media/2eaa512d-1293-4e9b-b927-6bfe0fc0acb4.png)
  
На рисунке 3 показана виртуальная сеть, содержащая подсеть шлюза с шлюзом Azure и набором подсетей с размещением виртуальных машин, содержащих виртуальные машины.
  
Подсеть шлюза Azure требуется службе Azure для размещения двух виртуальных машин шлюза Azure. Длина префикса для указываемого адресного пространства должна составлять хотя бы 29 бита (например: 192.168.15.248/29). Рекомендуется 27-или более короткая длина префикса, особенно при планировании использования ExpressRoute.
  
Рекомендуется определить адресное пространство подсети шлюза Azure:
  
1. Выберите размер подсети шлюза.
    
2. В переменных битах в адресном пространстве виртуальной сети задайте для битов, используемых для подсети шлюза, значение 0, а для оставшихся битов — значение 1.
    
3. Преобразуйте полученный результат в десятичный формат и выразите его как адресное пространство, длина префикса которого соответствует размеру подсети шлюза.
    
При использовании этого метода адресное пространство для подсети шлюза всегда будет находиться в самом конце адресного пространства виртуальной сети.
  
Вот пример определения префикса адреса для подсети шлюза: адресное пространство виртуальной сети — 10.119.0.0/16. Организация изначально будет использовать VPN-подключение типа "сеть-сеть", но в итоге перейдет на ExpressRoute. В таблице 2 представлены действия по определению префикса адреса для подсети шлюза в нотации сетевых префиксов и результаты этих действий.

Ниже приведены действия и примеры определения префикса адреса подсети шлюза.

1. Выберите размер подсети шлюза. В нашем примере мы выбрали/28.
2. Установите биты в переменной области адресов виртуальной сети (b) в 0 для битов подсети шлюза (G), в противном случае — 1 (V). Для нашего примера мы используем адресное пространство 10.119.0.0/16 для виртуальной сети.
<br/>
<br/>10,119. бббббббб. бббббббб
<br/>10,119. ВВВВВВВВ. ВВВВГГГГ
<br/>10,119. 11111111. 11110000
<br/><br/>
3. Преобразовать результат из шага 2 в десятичное и выразить в качестве адресного пространства. В нашем примере — 10,119. 11111111. 11110000 — 10.119.255.240, а длина префикса — от шага 1 (28 в нашем примере), то полученный префикс адреса подсети шлюза равен 10.119.255.240/28.
  
Для получения дополнительных сведений см. [Калькулятор адресного пространства для подсетей шлюза Azure](https://gallery.technet.microsoft.com/scriptcenter/Address-prefix-calculator-a94b6eed) .
  
Подсети с размещенными виртуальными машинами — это сети, в которых размещаются виртуальные машины Azure, что можно сделать, руководствуясь стандартными инструкциями для локальных сетей, например, используя общую роль, уровень приложений или инструкции по изоляции подсети.
  
Azure использует первые 3 адреса в каждой подсети. Таким образом, число возможных адресов в подсети Azure составляет 2<sup>n</sup> -5, где n — это количество битов узла. В таблице 3 указано требуемое количество виртуальных машин и битов узлов, а также соответствующие размеры подсети.
  
|**Необходимо виртуальных машин**|**Биты узлов**|**Размер подсети**|
|:-----|:-----|:-----|
|1–3  <br/> |4  <br/> |/29  <br/> |
|4–11  <br/> |SP4  <br/> |/28  <br/> |
|12–27  <br/> |17:00  <br/> |/27  <br/> |
|28–59  <br/> |6   <br/> |/26  <br/> |
|60–123  <br/> |7   <br/> |/25  <br/> |
   
 **Таблица 3. Требования к виртуальным машинам и размерам подсети**
  
Для получения дополнительных сведений о максимальном объеме виртуальных машин в подсети или виртуальной сети ознакомьтесь с разделом [ограничения сети](https://docs.microsoft.com/azure/azure-subscription-service-limits#networking-limits).
  
Для получения дополнительных сведений просмотрите раздел [планирование и проектирование виртуальных сетей Azure](https://azure.microsoft.com/documentation/articles/virtual-network-vnet-plan-design-arm/).
  
### <a name="step-6-determine-the-dns-server-configuration-and-the-addresses-of-the-dns-servers-to-assign-to-vms-in-the-vnet"></a>Шаг 6. Определите конфигурацию DNS-сервера и адреса DNS-серверов для назначения виртуальным машинам в виртуальной сети.

Azure назначает виртуальным машинам адреса DNS-серверов с помощью сервера DHCP. DNS-серверы могут:
  
- предоставляться Azure: регистрация локального имени, а также разрешение локальных и интернет-имен;
    
- указываться вами: регистрация локального или интернет-имени, а также разрешение имен в интрасети или Интернете.
    
В таблице 4 представлены различные конфигурации DNS-сервера для каждого типа виртуальной сети.
    
|**Тип виртуальной сети**|**DNS-сервер**|
|:-----|:-----|
|Только облако  <br/> |Разрешение локальных и интернет-имен службой Azure  <br/> Виртуальная машина Azure для разрешения локальных и интернет-имен (переадресация DNS)  <br/> |
|Распределенная  <br/> |Разрешение локальных и интернет-имен локальной службой  <br/> Виртуальная машина Azure для разрешения локальных имен и имен в интрасети (репликация и переадресация DNS)  <br/> |
   
 **Таблица 4. Варианты DNS-серверов для двух различных типов виртуальных сетей**
  
Дополнительные сведения см. в разделе [разрешение имен для виртуальных машин и экземпляров ролей](https://docs.microsoft.com/azure/virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances).
  
### <a name="step-7-determine-the-load-balancing-configuration-internet-facing-or-internal"></a>Шаг 7. Определите конфигурацию балансировки нагрузки (для внутреннего или интернет-трафика).

В некоторых случаях входящий трафик требуется распределить по нескольким серверам, которым назначена одна и та же роль. В Azure IaaS имеются встроенные средства для этого в отношении внутреннего и интернет-трафика.
  
Подсистема балансировки нагрузки Azure для интернет-трафика случайным образом распределяет нежелательный входящий трафик из Интернета среди участников набора балансировки нагрузки. 
  
**Рис. 4. Внешний балансировщик нагрузки в Azure**

![Рис. 4. Внешний балансировщик нагрузки в Azure](media/eb5945e5-0c2b-40f1-b9ed-54bb2b0f9e59.png)
  
На рисунке 4 показана внешняя подсистема балансировки нагрузки в Azure, которая распределяет входящий трафик по правилу или конечной точке входящего NAT в набор виртуальных машин в наборе балансировки нагрузки.
  
Подсистема балансировки нагрузки Azure для внутреннего трафика случайным образом распределяет незапрошенный входящий трафик от других виртуальных машин или компьютеров в интрасети среди участников набора балансировки нагрузки.  
  
**Рис. 5. Внутренний балансировщик нагрузки в Azure**

![Рис. 5. Внутренний балансировщик нагрузки в Azure](media/d1451b73-6465-449d-b3e6-22160ce51f35.png)
  
На рисунке 5 показана внутренняя подсистема балансировки нагрузки в Azure, которая распределяет входящий трафик по правилу или конечной точке входящего NAT в набор виртуальных машин в наборе балансировки нагрузки.
  
Дополнительные сведения см. в [подсистеме балансировки нагрузки Azure](https://docs.microsoft.com/azure/load-balancer/load-balancer-overview).
  
### <a name="step-8-determine-the-use-of-virtual-appliances-and-user-defined-routes"></a>Шаг 8. Определите порядок использования виртуальных модулей и пользовательских маршрутов в Azure.

Если требуется перенаправить трафик на виртуальные модули в виртуальной сети, возможно, в подсеть потребуется добавить один или несколько пользовательских маршрутов.
  
**Рис. 6. Виртуальные устройства и пользовательские маршруты в Azure**

![Рис. 6. Виртуальные устройства и пользовательские маршруты в Azure](media/f181d0f4-ebf9-439e-9c98-dec17428c32b.png)
  
На рисунке 6 представлена распределенная виртуальная сеть и пользовательский маршрут, назначенный подсети с размещенными виртуальными машинами, которая указывает на виртуальный модуль.
  
Для получения дополнительных сведений см [](https://docs.microsoft.com/azure/virtual-network/virtual-networks-udr-overview).
  
### <a name="step-9-determine-how-computers-from-the-internet-will-connect-to-virtual-machines"></a>Шаг 9. Определите, как компьютеры из Интернета будут автоматически подключаться к виртуальным машинам.

Существуют различные способы предоставить виртуальным машинам в виртуальной сети доступ к Интернету, который включает доступ из сети организации через прокси-сервер или другое пограничное устройство.
  
В таблице 5 перечислены способы фильтрации или проверки незапрошенного входящего трафика.
  
|**Метод**|**Модель развертывания**|
|:-----|:-----|
|1. Конечные точки и списки управления доступом, настроенные в облачных службах  <br/> |Базовая  <br/> |
|2. Группы безопасности сети  <br/> |Классическая с использованием диспетчера ресурсов  <br/> |
|3. Подсистема балансировки нагрузки для интернет-трафика с правилами NAT для входящего трафика  <br/> |Руководитель ресурсов  <br/> |
|4. устройства сетевой безопасности в Azure Marketplace (не показаны)  <br/> |Классическая с использованием диспетчера ресурсов  <br/> |
   
 **Таблица 5. Способы подключения к виртуальным машинам и соответствующие модели развертывания Azure**
  
**Рис. 7. Подключение к виртуальным машинам Azure через Интернет**

![Рис. 7. Подключение к виртуальным машинам Azure через Интернет](media/c5e3531b-170a-4482-a6ff-fb8fbbe81b35.png)
  
На рисунке 7 показано подключение компьютера с доступом в Интернет к виртуальной машине в облачной службе через конечную точку, к виртуальной машине в подсети с помощью группы безопасности сети, а также к виртуальной машине в подсети с помощью внешней подсистемы балансировки нагрузки и правил NAT для входящего трафика.
  
Дополнительная безопасность обеспечивается за счет следующего:
  
- Подключение удаленного рабочего стола и подключение SSH, которые зашифрованы и используют проверку подлинности.
    
- Сеансы удаленной среды PowerShell, которые зашифрованы и используют проверку подлинности.
    
- Режим транспорта IPsec, который можно использовать для сквозного шифрования.
    
- Защита Azure от атак DDoS, позволяющая предотвратить внешние и внутренние атаки.
    
Для получения дополнительных сведений обратитесь [к разделу Безопасность Microsoft Cloud для корпоративных архитекторов](https://aka.ms/cloudarchsecurity) и [безопасности сети Azure](https://azure.microsoft.com/blog/azure-network-security/).
  
### <a name="step-10-for-multiple-vnets-determine-the-vnet-to-vnet-connection-topology"></a>Шаг 10. Если имеется несколько виртуальных сетей, определите топологию подключения "виртуальная сеть–виртуальная сеть".

Виртуальные сети можно подключать между собой, используя для этого такие же топологии, что и для подключения сайтов организации.
  
Гирляндная конфигурация подразумевает последовательное подключение виртуальных сетей.
  
**Рис. 8. Конфигурация с последовательным подключением виртуальных сетей**

![Рисунок 8: последовательное конфигурирование для виртуальных сетей Azure](media/264d5dd4-06c5-483f-9428-a18cc1f68ac1.png)
  
На рисунке 8 показано пять виртуальных сетей, подключенных к ряду с использованием последовательной конфигурации.
  
Звездообразная конфигурация подразумевает подключение нескольких виртуальных сетей к ряду центральных виртуальных сетей, соединенных между собой.
  
**Рис. 9. Звездообразная конфигурация виртуальных сетей**

![На рисунке 9: Конфигурация "лучевой" и "Hub" для виртуальных сетей Azure](media/dd442a38-5b76-4ac5-b743-8fc7711a91ba.png)
  
На рисунке 9 показаны шесть виртуальных сетей, где две из которых являются центральными сетями, соединенными между собой, а остальные виртуальные сети подключены к этим центральным сетям.
  
В конфигурации полной сетки все виртуальные сети соединены непосредственно друг с другом.
  
**Рис. 10. Конфигурация полной сетки для виртуальных сетей**

![Рисунок 10: Конфигурация сетки для виртуальных сетей Azure](media/9dda0738-10db-4a63-95b3-79851a399b71.png)
  
На рисунке 10 показаны четыре виртуальные сети, которые подключены непосредственно друг к другу с помощью шести подключений типа "виртуальная сеть–виртуальная сеть".
  
## <a name="planning-steps-for-a-cross-premises-vnet"></a>Этапы планирования для распределенной виртуальной сети
<a name="cross_prem"> </a>

Ниже перечислены шаги, которыми следует руководствоваться при планировании распределенной виртуальной сети.
  
> [!TIP]
> Сведения о том, как создать имитацию гибридной среды разработки и тестирования в Azure, см. в статье [Simulated cross-premises virtual network in Azure](simulated-cross-premises-virtual-network-in-azure.md). 
  
### <a name="step-1-determine-the-cross-premises-connection-to-the-vnet-s2s-vpn-or-expressroute"></a>Шаг 1. Определите тип подключения к распределенной виртуальной сети (подключение VPN типа "сеть–сеть" или ExpressRoute).

В таблице 6 перечислены различные типы подключений.
  
|**Тип подключения**|**Назначение**|
|:-----|:-----|
|VPN типа "сеть–сеть"  <br/> |Подключите сайты 1-10 (в том числе другие виртуальных сетей) к одной виртуальной сети.  <br/> |
|ExpressRoute  <br/> |Закрытое, защищенное подключение к Azure через поставщика услуг обмена интернет-трафиком (IXP) или поставщика сетевых услуг (NSP).  <br/> |
|Подключение VPN типа "точка–сеть"  <br/> |Подключение отдельного компьютера к виртуальной сети.  <br/> |
|Пиринговая виртуальная сеть или VNet-to-VNet (V2V) VPN   <br/> |Подключение одной виртуальной сети к другой.  <br/> |
   
 **Таблица 6. Типы подключений для распределенных виртуальных сетей**
  
Для получения дополнительных сведений о максимальном количестве подключений, ознакомьтесь с разделом [ограничения сети](https://docs.microsoft.com/azure/azure-subscription-service-limits#networking-limits).
  
Дополнительные сведения о VPN-устройствах можно узнать в статье [VPN-устройства для подключений к виртуальной сети типа](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-about-vpn-devices)"сеть-сеть".
  
Для получения дополнительных сведений об одноранговом уровне виртуальной сети обратитесь к разделу [пиринг виртуальной](https://docs.microsoft.com/azure/virtual-network/virtual-network-peering-overview)сети.
  
**Рис. 11. Четыре способа подключения к распределенной виртуальной сети**

![На рисунке 11: три способа подключения к виртуальной сети Azure с несколькими организациями](media/d5d4a625-cfbd-4a77-9159-eaca69d07e93.png)
  
На рисунке 11 показана виртуальная сеть с четырьмя типами подключений: подключение к P2S с компьютера, VPN-подключение S2S из локальной сети, подключение ExpressRoute из локальной сети и подключение типа "сеть-сеть" из другой виртуальной сети. 
  
Подключиться к виртуальным машинам в виртуальной сети можно следующими способами:
  
- Администрирование виртуальных машин в виртуальной сети из локальной сети или через Интернет
    
- Доступ к рабочей ИТ-нагрузке из локальной сети
    
- Расширение сети с помощью дополнительных виртуальных сетей
    
Безопасность подключений обеспечивается за счет следующего:
  
- Для подключения типа "точка–сеть" используется протокол Secure Socket Tunneling Protocol (SSTP)  
    
- Для подключений VPN типа "сеть–сеть" и "виртуальная сеть–виртуальная сеть" используется туннельный режим IPsec с шифрованием AES256
    
- ExpressRoute представляет собой частное подключение WAN
    
Для получения дополнительных сведений обратитесь [к разделу Безопасность Microsoft Cloud для корпоративных архитекторов](https://aka.ms/cloudarchsecurity) и [безопасности сети Azure](https://azure.microsoft.com/blog/azure-network-security/).
  
### <a name="step-2-determine-the-on-premises-vpn-device-or-router"></a>Шаг 2. Определите локальное VPN-устройство или маршрутизатор.

Локальное VPN-устройство или маршрутизатор выступает в качестве:
  
- оконечного узла IPsec подключения VPN типа "сеть–сеть" от шлюза Azure;
    
- узла BPG и оконечной точки для частного пирингового подключения ExpressRoute.
    
**Рис. 12. Локальный маршрутизатор или устройство VPN**

![Рис. 12. Локальный маршрутизатор или устройство VPN](media/bd221468-a660-4730-aa55-0426986480b9.png)
  
На рисунке 12 показана распределенная виртуальная сеть, подключенная к локальному VPN-устройству или маршрутизатору.
  
Более подробную информацию можно узнать в разделе [о шлюзе VPN](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-about-vpngateways).
  
### <a name="step-3-add-routes-to-your-intranet-to-make-the-address-space-of-the-vnet-reachable"></a>Шаг 3: Добавление маршрутов в интрасеть для предоставления достижимости адресного пространства для виртуальной сети.

Маршрут к виртуальной сети из локальной сети включает следующее:
  
1. Маршрут для адресного пространства виртуальной сети до вашего VPN-устройства.
    
2. Маршрут для адресного пространства виртуальной сети на VPN-устройстве до подключения VPN типа "сеть–сеть"или подключения ExpressRoute.
    
**Рис. 13. Локальные маршруты, необходимые для того, чтобы сделать виртуальную сеть доступной**

![Рисунок 13: Локальные маршруты, необходимые для обеспечения достижимости виртуальной сети Azure](media/7a1e20c1-fbc4-4cb9-9961-735da4e23307.png)
  
На рисунке 13 показаны сведения о маршрутах, необходимые локальным маршрутизаторам и VPN-устройству или маршрутизатору, представляющему адресное пространство виртуальной сети.
  
### <a name="step-4-for-expressroute-plan-for-the-new-connection-with-your-provider"></a>Шаг 4. Если используется подключение ExpressRoute, спланируйте новое подключение вместе со своим поставщиком.

Создать частное пиринговое соединение ExpressRoute между локальной сетью и облаком Майкрософт можно тремя различными способами:
  
- Совместное размещение в облачном обменнике
    
- Подключение типа "точка-точка" через Ethernet
    
- Подключение типа "любой-к-любому" (IP-VPN)
    
**Рис. 14. Использование ExpressRoute для подключения к распределенной виртуальной сети**

![Рисунок 14: использование ExpressRoute для подключения к нескольким локальным виртуальным сетям Azure](media/7030bd39-69a6-4283-8567-3434e1ab6ba6.png)
  
На рисунке 14 показана распределенная виртуальная сеть и подключение ExpressRoute от локального маршрутизатора к Microsoft Azure.
  
Дополнительные сведения см. в статье [ExpressRoute для подключения к Microsoft Cloud](expressroute-for-microsoft-cloud-connectivity.md).
  
### <a name="step-5-determine-the-local-network-address-space-for-the-azure-gateway"></a>Шаг 5. Определите адресное пространство локальной сети для шлюза Azure.

Для маршрутизации трафика в локальную сеть или другие виртуальные сети Azure переадресовывает его через шлюз Azure, соответствующий адресному пространству локальной сети, которое назначено шлюзу.
  
**Рис. 15. Адресное пространство локальной сети для распределенной виртуальной сети**

![Рисунок 15: адресное пространство локальной сети для локальной виртуальной сети Azure](media/e3af2652-8b8e-4551-9a0b-b550e6e7e3c0.png)
  
На рисунке 15 показаны распределенная виртуальная сеть и адресное пространство локальной сети на шлюзе Azure, которое представляет собой достижимое адресное пространство локальной сети.  
  
Адресное пространство локальной сети можно определить следующими способами:
  
- Способ 1. Создание списка префиксов адресного пространства, которые требуются или используются (этот список необходимо обновлять при добавлении новых подсетей).
    
- Способ 2. Использование всего адресного пространства локальной сети (этот список необходимо обновлять только при добавлении нового адресного пространства).
    
Поскольку шлюз Azure не поддерживает суммированные маршруты, необходимо определить адресное пространство локальной сети для способа 2, исключив из него адресное пространство виртуальной сети.
  
**Рис. 16. Пробел в адресном пространстве, созданный адресным пространством виртуальной сети**

![Рисунок 16: адресное пространство, созданное адресным пространством виртуальной сети](media/e79c4840-f9e3-4741-9b72-59db6043aefa.png)
  
На рисунке 16 представлено адресное пространство с корневым пространством и адресным пространством виртуальной сети.
  
Ниже приведен пример определения префиксов для адресного пространства локальной сети вокруг адресного пространства "дыра", созданного виртуальной сетью:
  
- Организация использует фрагменты частного адресного пространства (10.0.0.0/8, 172.16.0.0/12 и 192.168.0.0/16) в своей локальной сети. Был выбран способ 2, а в качестве адресного пространства виртуальной сети — пространство 10.100.100.0/24.
    
В таблице 7 представлены действия и полученные в их результате префиксы, определяющие адресное пространство локальной сети для этого примера.
  
|**Шаг**|**Results**|
|:-----|:-----|
|1. Создание списка префиксов, которые отсутствуют в корневом пространстве, для адресного пространства виртуальной сети.  <br/> |172.16.0.0/12 и 192.168.0.0/16  <br/> |
|2. Перечислите непересекающиеся префиксы для переменных октетов, которые не включают последний использованный октет в адресном пространстве виртуальной сети.  <br/> |10.0.0.0/16, 10.1.0.0/16... 10.99.0.0/16, 10.101.0.0/16... 10.254.0.0/16, 10.255.0.0/16 (префиксы 255, пропуск 10.100.0.0/16)  <br/> |
|3. Перечислите непересекающиеся префиксы в последнем использованном октете адресного пространства виртуальной сети.  <br/> |10.100.0.0/24, 10.100.1.0/24... 10.100.99.0/24, 10.100.101.0/24... 10.100.254.0/24, 10.100.0.255.0/24 (префиксы 255, пропуск 10.100.100.0/24)  <br/> |
   
 **Таблица 7. Пример сетевого пространства локальных адресов**
  
### <a name="step-6-configure-on-premises-dns-servers-for-dns-replication-with-dns-servers-hosted-in-azure"></a>Шаг 6. Настройте локальные DNS-серверы на репликацию DNS с помощью DNS-серверов, размещенных в Azure.

Чтобы локальные компьютеры могли разрешать имена серверов, размещенных в Azure, а последние могли разрешать имена локальных компьютеров, настройте следующее:
  
- DNS-серверы в вашей виртуальной сети на переадресацию на локальные DNS-серверы;
    
- репликацию DNS для соответствующих зон между DNS-серверами локальной и виртуальной сетей.
    
**Рис. 17. Репликация и переадресация DNS для DNS-сервера в распределенной виртуальной сети**

![Рисунок 17: репликация и пересылка DNS для DNS-сервера в виртуальной сети Azure с несколькими организациями](media/ab55e5ce-ccb0-49d4-a301-657a727f97b2.png)
  
На рисунке 17 показана распределенная виртуальная сеть с DNS-серверами в локальной сети и подсети в виртуальной сети. Между этими двумя DNS-серверами настроены репликация и переадресация DNS.
  
### <a name="step-7-determine-the-use-of-forced-tunneling"></a>Шаг 7. Определите использование принудительного туннелирования.

Системный маршрут по умолчанию для подсетей Azure указывает на Интернет. Чтобы убедиться, что весь трафик из виртуальных машин проходит через локальное подключение, создайте таблицу маршрутизации с маршрутом по умолчанию, который использует шлюз Azure в качестве адреса следующего прыжка. Затем вы связываете таблицу маршрутизации с подсетью. Это называется принудительным туннелированием. Для получения дополнительных сведений см [Настройка принудительного туннелирования](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-forced-tunneling-rm).
  
**Рис. 18. Пользовательские маршруты и принудительное туннелирование для распределенной виртуальной сети**

![Рисунок 18: пользовательские маршруты и принудительное туннелирование для виртуальной сети Azure с несколькими организациями](media/1e545ec6-c2d9-48d2-bb5e-e0a581fee004.png)
  
На рисунке 18 показана распределенная виртуальная сеть с пользовательским маршрутом для подсети, указывающей на шлюз Azure.
  
## <a name="sharepoint-server-2016-farm-in-azure"></a>Ферма SharePoint Server 2016 в Azure
<a name="cross_prem"> </a>

Примером рабочей нагрузки в интрасети, размещенной в Azure IaaS, является высокодоступная многоуровневая ферма SharePoint Server 2016.
  
**Рисунок 19. Высокодоступная ферма SharePoint Server 2016 в интрасети в Azure IaaS**

![Ферма SharePoint Server 2016 С высоким уровнем доступности в Azure IaaS](media/3a922e21-df91-455f-ba90-78abdd48d98d.png)
  
На рисунке 19 показаны девять серверов фермы SharePoint Server 2016, развернутые в распределенной виртуальной сети, в которой используются внутренние подсистемы балансировки нагрузки для уровней сервера переднего плана и данных. Для получения дополнительных сведений, включая пошаговые инструкции по проектированию и развертыванию, ознакомьтесь со статьей [SharePoint Server 2016 в Microsoft Azure](https://docs.microsoft.com/SharePoint/administration/sharepoint-server-2016-in-microsoft-azure).
  
> [!TIP]
> Чтобы создать ферму SharePoint Server 2016 с одним сервером в имитируемой распределенной виртуальной сети, ознакомьтесь со статьей [интрасеть SharePoint server 2016 в среде разработки и тестирования Azure](https://docs.microsoft.com/SharePoint/administration/intranet-sharepoint-server-2016-in-azure-dev-test-environment). 
  
Дополнительные примеры рабочих нагрузок, развернутых на виртуальных машинах в виртуальной сети Azure, приведены в статье [гибридные облачные сценарии для Azure IaaS](https://docs.microsoft.com/office365/enterprise/hybrid-cloud-scenarios-for-azure-iaas).
  
## <a name="see-also"></a>См. также

[Организация сети в Microsoft Cloud для корпоративных архитекторов](microsoft-cloud-networking-for-enterprise-architects.md)
  
[Ресурсы для администраторов, посвященные архитектуре Microsoft Cloud](microsoft-cloud-it-architecture-resources.md)


